(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{7450:function(e,a,t){Promise.resolve().then(t.bind(t,3768))},3768:function(e,a,t){"use strict";t.r(a),t.d(a,{default:function(){return v}});var n=t(7437),i=t(2265),r=t(9376),s=t(2249);function l(e){let{product:a,onEdit:t,onDelete:i,dragHandleProps:r}=e,s=a.imageUrl;return s?s.startsWith("http")||s.startsWith("data:")||(s=s.startsWith("/")?"https://www.kinkoshioji.co.jp".concat(s):"https://www.kinkoshioji.co.jp/img/goods/".concat(s)):s="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQ4IiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQ4IiBoZWlnaHQ9IjEyMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77niYfliqDovb3lpLHotKU8L3RleHQ+PC9zdmc+",(0,n.jsxs)("div",{className:"product-card",children:[r&&(0,n.jsx)("div",{...r,className:"drag-handle",style:{position:"absolute",top:"5px",right:"5px",cursor:"grab",padding:"5px",fontSize:"18px",color:"#999",userSelect:"none"},title:"拖拽排序",children:"⋮⋮"}),(0,n.jsx)("img",{src:s,alt:a.nameJa||a.name,className:"product-image",onError:e=>{e.target.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQ4IiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQ4IiBoZWlnaHQ9IjEyMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77niYfliqDovb3lpLHotKU8L3RleHQ+PC9zdmc+"}}),(0,n.jsx)("div",{className:"product-name",children:a.nameJa||a.name}),(0,n.jsxs)("div",{className:"product-price ".concat(a.isNewPrice?"new-price":""),children:[a.isNewPrice&&(0,n.jsx)("span",{className:"new-price-badge",children:"New Price"}),(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"price-value",children:a.price.toLocaleString("ja-JP")}),(0,n.jsxs)("span",{className:"price-unit",children:["円/",a.unit]})]})]}),(0,n.jsxs)("div",{className:"actions",style:{marginTop:"15px"},children:[(0,n.jsx)("button",{className:"btn btn-secondary btn-small",onClick:()=>t(a),children:"編集"}),(0,n.jsx)("button",{className:"btn btn-danger btn-small",onClick:()=>i(a.id),children:"削除"})]})]})}var c=t(3464);let o="kinkoshioji-admin-bc3488451141916f",d=c.Z.create({baseURL:"https://api.kinkoshioji.co.jp",headers:{"Content-Type":"application/json"}});async function u(){return(await d.get("/api/products")).data}async function p(e){return(await d.post("/api/products",e,{headers:{Authorization:"Bearer ".concat(o)}})).data.product}async function m(e,a){return(await d.put("/api/products/".concat(e),a,{headers:{Authorization:"Bearer ".concat(o)}})).data.product}async function h(e){await d.delete("/api/products/".concat(e),{headers:{Authorization:"Bearer ".concat(o)}})}async function g(e){let a=new FormData;return a.append("file",e),(await d.post("/api/upload",a,{headers:{Authorization:"Bearer ".concat(o),"Content-Type":"multipart/form-data"}})).data}async function j(e){return(await d.put("/api/products/reorder",{productIds:e},{headers:{Authorization:"Bearer ".concat(o)}})).data.products}function x(e){let{onUploadComplete:a,currentImageUrl:t}=e,[r,s]=(0,i.useState)(null),[l,c]=(0,i.useState)(t||""),[o,d]=(0,i.useState)(!1),[u,p]=(0,i.useState)(null);(0,i.useRef)(null);let m=e=>new Promise((a,t)=>{let n=new FileReader;n.onload=n=>{var i;let r=new Image;r.onload=()=>{let n=r.width/r.height,i=248/120,s=0,l=0,o=r.width,d=r.height;n>i?(o=(d=r.height)*i,s=(r.width-o)/2):(d=(o=r.width)/i,l=(r.height-d)/2);let u=document.createElement("canvas");u.width=248,u.height=120;let p=u.getContext("2d");if(!p){t(Error("无法创建 canvas 上下文"));return}p.drawImage(r,s,l,o,d,0,0,248,120),u.toBlob(n=>{if(!n){t(Error("图片转换失败"));return}let i=new File([n],e.name,{type:e.type||"image/jpeg",lastModified:Date.now()});c(u.toDataURL(e.type||"image/jpeg",.9)),a(i)},e.type||"image/jpeg",.9)},r.onerror=t,r.src=null===(i=n.target)||void 0===i?void 0:i.result},n.onerror=t,n.readAsDataURL(e)}),h=async e=>{var a;let t=null===(a=e.target.files)||void 0===a?void 0:a[0];if(t){s(t),p(null);try{let e=await m(t);s(e)}catch(a){p("画像の処理に失敗しました"),console.error(a);let e=new FileReader;e.onloadend=()=>{c(e.result)},e.readAsDataURL(t)}}},j=async()=>{if(r)try{d(!0),p(null);let e=await g(r);a(e.url),s(null),l.startsWith("blob:")&&URL.revokeObjectURL(l),c("")}catch(e){p("画像のアップロードに失敗しました"),console.error(e)}finally{d(!1)}};return(0,n.jsxs)("div",{children:[(0,n.jsx)("input",{type:"file",accept:"image/*",onChange:h,style:{marginBottom:"10px"}}),l&&(0,n.jsx)("img",{src:l,alt:"Preview",className:"image-preview"}),r&&(0,n.jsxs)("div",{children:[(0,n.jsx)("button",{type:"button",className:"btn btn-secondary btn-small",onClick:j,disabled:o,style:{marginTop:"10px"},children:o?"アップロード中...":"画像をアップロード"}),u&&(0,n.jsx)("div",{className:"error",style:{marginTop:"10px"},children:u})]})]})}function b(e){let{product:a,onClose:t,onSave:r}=e,[s,l]=(0,i.useState)({name:"",nameJa:"",imageUrl:"",price:0,unit:"kg",isNewPrice:!1}),[c,o]=(0,i.useState)(!1),[d,u]=(0,i.useState)(null);(0,i.useEffect)(()=>{a&&l({name:a.name||"",nameJa:a.nameJa||"",imageUrl:a.imageUrl||"",price:a.price||0,unit:a.unit||"kg",isNewPrice:a.isNewPrice||!1})},[a]);let h=async e=>{if(e.preventDefault(),!s.nameJa&&!s.name){u("商品名を入力してください");return}if(s.price<0){u("価格は0以上である必要があります");return}try{o(!0),u(null);let e={...s};a?await m(a.id,e):await p(e),r()}catch(e){u("保存に失敗しました"),console.error(e)}finally{o(!1)}};return(0,n.jsx)("div",{className:"modal active",onClick:t,children:(0,n.jsxs)("div",{className:"modal-content",onClick:e=>e.stopPropagation(),children:[(0,n.jsxs)("div",{className:"modal-header",children:[(0,n.jsx)("h2",{children:a?"商品を編集":"新しい商品を追加"}),(0,n.jsx)("span",{className:"close",onClick:t,children:"\xd7"})]}),d&&(0,n.jsx)("div",{className:"error",children:d}),(0,n.jsxs)("form",{onSubmit:h,children:[(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"商品名（日本語）*"}),(0,n.jsx)("input",{type:"text",value:s.nameJa,onChange:e=>l({...s,nameJa:e.target.value}),required:!0})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"商品名（英語）"}),(0,n.jsx)("input",{type:"text",value:s.name,onChange:e=>l({...s,name:e.target.value})})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"画像"}),(0,n.jsx)(x,{onUploadComplete:e=>{l(a=>({...a,imageUrl:e}))},currentImageUrl:s.imageUrl}),s.imageUrl&&(0,n.jsxs)("div",{style:{marginTop:"10px",fontSize:"12px",color:"#666"},children:["現在の画像URL: ",s.imageUrl]})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"価格（円）*"}),(0,n.jsx)("input",{type:"number",value:s.price,onChange:e=>l({...s,price:parseFloat(e.target.value)||0}),min:"0",step:"0.01",required:!0})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"単位*"}),(0,n.jsxs)("select",{value:s.unit,onChange:e=>l({...s,unit:e.target.value}),required:!0,children:[(0,n.jsx)("option",{value:"kg",children:"kg"}),(0,n.jsx)("option",{value:"台",children:"台"}),(0,n.jsx)("option",{value:"個",children:"個"})]})]}),(0,n.jsx)("div",{className:"form-group",children:(0,n.jsxs)("label",{children:[(0,n.jsx)("input",{type:"checkbox",checked:s.isNewPrice,onChange:e=>l({...s,isNewPrice:e.target.checked})}),"New Price タグを表示"]})}),(0,n.jsxs)("div",{className:"actions",children:[(0,n.jsx)("button",{type:"button",className:"btn btn-secondary",onClick:t,children:"キャンセル"}),(0,n.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:c,children:c?"保存中...":"保存"})]})]})]})})}function v(){let[e,a]=(0,i.useState)([]),[t,c]=(0,i.useState)(!0),[o,d]=(0,i.useState)(null),[p,m]=(0,i.useState)(!1),[g,x]=(0,i.useState)(null),[v,y]=(0,i.useState)(!1),f=(0,r.useRouter)();(0,i.useEffect)(()=>{if("true"!==localStorage.getItem("admin_authenticated")){f.push("/login");return}y(!0),w()},[f]);let w=async()=>{try{c(!0),d(null);let e=await u();a(e.products||[])}catch(e){d("商品データの読み込みに失敗しました"),console.error(e)}finally{c(!1)}},N=e=>{x(e),m(!0)},I=async e=>{if(confirm("この商品を削除してもよろしいですか？"))try{await h(e),await w()}catch(e){d("商品の削除に失敗しました"),console.error(e)}},k=()=>{m(!1),x(null)},C=async t=>{if(!t.destination)return;let n=Array.from(e),[i]=n.splice(t.source.index,1);n.splice(t.destination.index,0,i),a(n);try{let e=n.map(e=>e.id);await j(e)}catch(e){console.error("Failed to reorder products:",e),w()}};return v?(0,n.jsxs)("div",{className:"container",children:[(0,n.jsx)("div",{className:"header",children:(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{children:"商品管理システム"}),(0,n.jsx)("p",{children:"商品の追加、編集、削除ができます"})]}),(0,n.jsx)("button",{onClick:()=>{localStorage.removeItem("admin_authenticated"),f.push("/login")},className:"btn btn-secondary",style:{marginTop:"0"},children:"ログアウト"})]})}),o&&(0,n.jsxs)("div",{className:"error",children:[o,(0,n.jsx)("button",{onClick:()=>d(null),style:{float:"right",background:"none",border:"none",cursor:"pointer"},children:"\xd7"})]}),(0,n.jsx)("div",{className:"add-product-btn",children:(0,n.jsx)("button",{className:"btn btn-primary",onClick:()=>{x(null),m(!0)},children:"+ 新しい商品を追加"})}),t?(0,n.jsx)("div",{className:"loading",children:"読み込み中..."}):(0,n.jsx)(s.Z5,{onDragEnd:C,children:(0,n.jsx)(s.bK,{droppableId:"products",children:a=>(0,n.jsxs)("div",{...a.droppableProps,ref:a.innerRef,className:"products-grid",children:[e.map((e,a)=>(0,n.jsx)(s._l,{draggableId:e.id,index:a,children:(a,t)=>(0,n.jsx)("div",{ref:a.innerRef,...a.draggableProps,style:{...a.draggableProps.style,opacity:t.isDragging?.8:1,zIndex:t.isDragging?1e3:1},children:(0,n.jsx)(l,{product:e,onEdit:N,onDelete:I,dragHandleProps:a.dragHandleProps})})},e.id)),a.placeholder]})})}),p&&(0,n.jsx)(b,{product:g,onClose:k,onSave:()=>{w(),k()}})]}):(0,n.jsx)("div",{className:"loading",children:"認証中..."})}}},function(e){e.O(0,[216,217,971,117,744],function(){return e(e.s=7450)}),_N_E=e.O()}]);